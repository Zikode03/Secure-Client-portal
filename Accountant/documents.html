<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Documents | Prospera Accountant Portal</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* ===== GLOBAL ===== */
body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f8fafc;
  color: #0f172a;
}

.app-layout{display:flex;min-height:100vh;width:100%;}

/* SIDEBAR */
.sidebar{
  width:260px;
  background:linear-gradient(180deg,#0f172a,#020617);
  color:white;
  display:flex;
  flex-direction:column;
  position:fixed;
  height:100vh;
}
.sidebar-header{
  padding:22px;
  display:flex;
  gap:12px;
  align-items:center;
}
.sidebar-header i{font-size:30px;color:#60a5fa;}
.sidebar-header h1{font-size:16px;}
.sidebar-header p{font-size:12px;color:#94a3b8;}

.nav{padding:16px;flex:1;}
.nav a{
  display:flex;
  gap:12px;
  align-items:center;
  padding:12px 14px;
  border-radius:10px;
  color:#cbd5f5;
  text-decoration:none;
  margin-bottom:6px;
}
.nav a:hover{background:#1e293b;}
.nav a.active{background:#2563eb;color:white;}

.sidebar-footer{padding:16px;}
.user-box{
  background:#1e293b;
  padding:12px;
  border-radius:10px;
  margin-bottom:12px;
}
.role{color:#60a5fa;font-size:12px;}

.logout{
  width:100%;
  background:none;
  border:none;
  color:#cbd5f5;
  padding:12px;
  border-radius:10px;
  cursor:pointer;
  text-align:left;
}
.logout:hover{background:#1e293b;}


.page{
  flex:1;
  margin-left:260px;
  padding:24px;
}
h2 {
  font-size: 28px;
  font-weight: 600;
  margin: 0;
}

.subtitle {
  margin-top: 8px;
  color: #64748b;
}

/* ===== HEADER ===== */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.button {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  background: #2563eb;
  color: white;
}

.button-outline {
  background: white;
  border: 1px solid #d1d5db;
  color: #374151;
}

.button-ghost {
  background: transparent;
  border: none;
  color: #374151;
  cursor: pointer;
}

.button-icon {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  background: white;
  cursor: pointer;
}

/* ===== CARD ===== */
.card {
  background: white;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}
.card-header {
  padding: 20px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}


.card-title {
  font-size: 16px;
  font-weight: 600;
}

.card-content {
  padding: 0;
}

/* ===== SEARCH ===== */
.search-wrapper {
  position: relative;
  width: 260px;
}

.search-wrapper input {
  width: 100%;
  padding: 8px 12px 8px 36px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 14px;
}

.search-icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
}
.card-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.search-wrapper {
  position: relative;
  width: 260px;
  display: flex;
  align-items: center;
}

.search-wrapper input {
  height: 38px;
  width: 100%;
  padding: 0 12px 0 36px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 14px;
}

.button-icon {
  height: 38px;
  width: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.filter-select {
  height: 38px;
  padding: 0 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 14px;
  cursor: pointer;
}


/* ===== TABLE ===== */
table {
  width: 100%;
  border-collapse: collapse;
}

thead {
  background: #f9fafb;
}

th, td {
  padding: 14px 16px;
  text-align: left;
  font-size: 14px;
}

th {
  color: #64748b;
  font-weight: 500;
}

tbody tr {
  border-top: 1px solid #e5e7eb;
}

tbody tr:hover {
  background: #f9fafb;
}

.actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

/* ===== STATUS BADGES ===== */
.badge {
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 500;
  text-transform: capitalize;
}

.completed {
  background: #dcfce7;
  color: #166534;
}

.pending {
  background: #fef9c3;
  color: #854d0e;
}

.in-review {
  background: #e0f2fe;
  color: #075985;
}

.approved {
  background: #ede9fe;
  color: #5b21b6;
}

.file-icon {
  margin-right: 8px;
  color: #6b7280;
}

/* ===== ACTION DROPDOWN ===== */
.dropdown {
  position: relative;
}

.menu-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: 6px;
}

.menu-btn:hover {
  background: #f1f5f9;
}

.dropdown-menu {
  position: absolute;
  right: 0;
  top: 38px;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  min-width: 150px;
  display: none;
  z-index: 20;
}

.dropdown-menu button {
  width: 100%;
  border: none;
  background: none;
  text-align: left;
  padding: 10px 12px;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
}

.dropdown-menu button:hover {
  background: #f8fafc;
}

.dropdown.active .dropdown-menu {
  display: block;
}

/* ===== MODAL ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal.show{
  display:flex;
}

.modal-content{
  width:500px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 20px 45px rgba(0,0,0,0.15);
  overflow:hidden;
  animation:fadeIn .2s ease;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px);}
  to{opacity:1;transform:translateY(0);}
}

.modal-header{
  padding:16px 20px;
  border-bottom:1px solid #e5e7eb;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.close-btn{
  border:none;
  background:none;
  cursor:pointer;
  font-size:18px;
}

.modal-body{
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:16px;
}

.upload-drop{
  border:2px dashed #cbd5e1;
  border-radius:10px;
  padding:30px;
  text-align:center;
  cursor:pointer;
  color:#64748b;
  transition:.2s;
}
.upload-drop:hover{
  border-color:#2563eb;
  background:#f8fafc;
}
.upload-drop i{
  font-size:26px;
  margin-bottom:8px;
  color:#2563eb;
}

.form-group{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.form-group input,
.form-group select{
  padding:10px;
  border:1px solid #d1d5db;
  border-radius:8px;
}

.modal-footer{
  padding:16px 20px;
  border-top:1px solid #e5e7eb;
  display:flex;
  justify-content:flex-end;
  gap:10px;
}

.btn-primary{
  background:#2563eb;
  color:white;
  border:none;
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
}

.btn-secondary{
  background:#fff;
  border:1px solid #d1d5db;
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
}


</style>
  <script defer src="accountant-nav.js"></script>
</head>

<body>

    
<div class="app-layout">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-header">
    <i class="fa-solid fa-shield-halved"></i>
    <div>
      <h1>Prospera</h1>
      <p>Accountant Portal</p>
    </div>
  </div>

  <nav class="nav">
    <a href="dashboards.html"><i class="fa fa-chart-line"></i> Dashboard</a>
    <a href="clients.html"><i class="fa fa-users"></i> Clients</a>
    <a href="documents.html" class="active"><i class="fa fa-file"></i> Documents</a>
     <a href="tasks.html" ><i class="fa fa-tasks"></i> Tasks</a>
    <a href="messages.html" ><i class="fa fa-message"></i> Messages</a>
    <a href="settings.html"><i class="fa fa-gear"></i> Settings</a>
  </nav>

  <div class="sidebar-footer">
    <div class="user-box">
      <p><strong>Sarah Johnson</strong></p>
      <p>sarah@prospera.com</p>
      <p class="role">Primary Accountant</p>
    </div>
    <button class="logout"><i class="fa fa-sign-out"></i> Logout</button>
  </div>
</aside>


<div class="page">

  <div class="header">
    <div>
      <h2>Documents</h2>
      <p class="subtitle">Manage and organize all your documents.</p>
    </div>
<button class="button" id="openUploadModal">
  <i class="fa-solid fa-upload"></i>
  Upload Document
</button>

  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title">All Documents</div>
      <div class="card-controls">
        <div class="search-wrapper">
          <i class="fa-solid fa-search search-icon"></i>
          <input type="text" id="searchInput" placeholder="Search documents...">
        </div>
        <select id="statusFilter" class="filter-select">
  <option value="all">All</option>
  <option value="completed">Completed</option>
  <option value="pending">Pending</option>
  <option value="in-review">In Review</option>
  <option value="approved">Approved</option>
</select>

      </div>
    </div>

    <div class="card-content">
      <table>
        <thead>
          <tr>
            <th>Document Name</th>
            <th>Client</th>
            <th>Category</th>
            <th>Status</th>
            <th>Date</th>
            <th style="text-align:right;">Actions</th>
          </tr>
        </thead>
        <tbody id="documentsTable"></tbody>
      </table>
    </div>
  </div>
</div>
</div>

<!-- ===== UPLOAD DOCUMENT MODAL ===== -->
<div id="uploadModal" class="modal">
  <div class="modal-content">

    <div class="modal-header">
      <h3>Upload Document</h3>
      <button class="close-btn" id="closeUpload">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="modal-body">

      <!-- Drag & Drop -->
      <label class="upload-drop" for="fileInput">
        <i class="fa-solid fa-cloud-arrow-up"></i>
        <p>Drag & drop files here</p>
        <small>or click to browse</small>
        <input type="file" id="fileInput" hidden>
      </label>

      <div class="form-group">
        <label>Client ID</label>
        <input type="text" id="clientIdInput" value="c_1001" placeholder="e.g. c_1001">
      </div>

      <div class="form-group">
        <label>Document Name</label>
        <input type="text" id="documentNameInput" placeholder="Enter document name">
      </div>

      <div class="form-group">
        <label>Category</label>
        <select id="categoryInput">
          <option>Tax Documents</option>
          <option>Invoices</option>
          <option>Reports</option>
          <option>Payroll</option>
          <option>Legal</option>
        </select>
      </div>
      <small id="uploadStatusText" style="display:block;margin-top:8px;color:#64748b;"></small>

    </div>

    <div class="modal-footer">
      <button class="btn-secondary" id="cancelUpload">Cancel</button>
      <button class="btn-primary" id="confirmUploadBtn">
        <i class="fa-solid fa-upload"></i> Upload
      </button>
    </div>

  </div>
</div>

<script>
let documents = [];
const clientsById = {};
const API_BASE_URL = "http://localhost:4000/api";
const token = localStorage.getItem("authToken");

if (!token) {
  window.location.href = "accountant logins/login.html";
}

function authHeaders() {
  return {
    "Content-Type": "application/json",
    Authorization: `Bearer ${token || ""}`,
  };
}

const tableBody = document.getElementById("documentsTable");
const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");
const uploadBtn = document.getElementById("openUploadModal");
const uploadModal = document.getElementById("uploadModal");
const closeUpload = document.getElementById("closeUpload");
const cancelUpload = document.getElementById("cancelUpload");
const confirmUploadBtn = document.getElementById("confirmUploadBtn");
const fileInput = document.getElementById("fileInput");
const clientIdInput = document.getElementById("clientIdInput");
const documentNameInput = document.getElementById("documentNameInput");
const categoryInput = document.getElementById("categoryInput");
const uploadStatusText = document.getElementById("uploadStatusText");

function setUploadStatus(message) {
  uploadStatusText.textContent = message || "";
}

function humanBytes(bytes) {
  const n = Number(bytes || 0);
  if (n < 1024) return `${n} B`;
  if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;
  if (n < 1024 * 1024 * 1024) return `${(n / (1024 * 1024)).toFixed(1)} MB`;
  return `${(n / (1024 * 1024 * 1024)).toFixed(1)} GB`;
}

function mapDoc(doc) {
  return {
    id: doc.id,
    name: doc.name,
    clientId: doc.clientId,
    client: clientsById[doc.clientId] || doc.clientId,
    category: doc.category,
    size: humanBytes(doc.sizeBytes),
    status: doc.status,
    date: (doc.uploadedAt || "").slice(0, 10),
  };
}

function renderDocuments(data) {
  tableBody.innerHTML = "";
  for (const doc of data) {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><i class="fa-regular fa-file-lines file-icon"></i>${doc.name}</td>
      <td>${doc.client}</td>
      <td>${doc.category}</td>
      <td><span class="badge ${doc.status}">${doc.status}</span></td>
      <td>${doc.date}</td>
      <td>
        <div class="actions">
          <div class="dropdown">
            <button class="button-icon menu-btn"><i class="fa-solid fa-ellipsis"></i></button>
            <div class="dropdown-menu">
              <button class="view-btn" data-doc-id="${doc.id}">
                <i class="fa-regular fa-eye"></i> View
              </button>
              <button data-download-id="${doc.id}">
                <i class="fa-solid fa-download"></i> Download
              </button>
            </div>
          </div>
        </div>
      </td>
    `;
    tableBody.appendChild(row);
  }
}

async function loadClientsMap() {
  const response = await fetch(`${API_BASE_URL}/clients`, { headers: authHeaders() });
  if (!response.ok) return;
  const data = await response.json();
  for (const client of data.items || []) {
    clientsById[client.id] = client.name;
  }
}

async function loadDocuments() {
  const query = new URLSearchParams();
  const searchValue = searchInput.value.trim();
  const statusValue = statusFilter.value;
  if (searchValue) query.set("search", searchValue);
  if (statusValue !== "all") query.set("status", statusValue);

  const response = await fetch(`${API_BASE_URL}/documents?${query.toString()}`, { headers: authHeaders() });
  if (!response.ok) throw new Error("Failed to fetch documents");
  const data = await response.json();
  documents = (data.items || []).map(mapDoc);
  renderDocuments(documents);
}

function applyFilters() {
  loadDocuments().catch((error) => console.error(error));
}

searchInput.addEventListener("input", applyFilters);
statusFilter.addEventListener("change", applyFilters);

document.addEventListener("click", function (e) {
  for (const drop of document.querySelectorAll(".dropdown")) {
    if (drop.contains(e.target)) {
      drop.classList.toggle("active");
    } else {
      drop.classList.remove("active");
    }
  }

  const viewBtn = e.target.closest(".view-btn");
  if (viewBtn) {
    window.location.href = `documentview.html?id=${encodeURIComponent(viewBtn.getAttribute("data-doc-id"))}`;
    return;
  }

  const downloadBtn = e.target.closest("[data-download-id]");
  if (downloadBtn) {
    const documentId = downloadBtn.getAttribute("data-download-id");
    fetch(`${API_BASE_URL}/documents/${encodeURIComponent(documentId)}/download-url`, {
      headers: authHeaders(),
    })
      .then((r) => r.json())
      .then((data) => {
        if (data.signedUrl) window.open(data.signedUrl, "_blank");
      })
      .catch((error) => console.error(error));
  }
});

async function uploadFileMultipart(file, metadata) {
  const initiateRes = await fetch(`${API_BASE_URL}/uploads/initiate`, {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({
      fileName: file.name,
      fileType: file.type || "application/octet-stream",
      fileSize: file.size,
      clientId: metadata.clientId,
      documentName: metadata.documentName,
      category: metadata.category,
      client: metadata.client,
    }),
  });
  if (!initiateRes.ok) {
    const error = await initiateRes.json().catch(() => ({}));
    throw new Error(error.error || "Failed to initialize upload");
  }

  const initiateData = await initiateRes.json();
  const partSize = initiateData.partSizeBytes || 8 * 1024 * 1024;
  const partCount = Math.ceil(file.size / partSize);
  const parts = [];

  for (let partNumber = 1; partNumber <= partCount; partNumber += 1) {
    const start = (partNumber - 1) * partSize;
    const end = Math.min(start + partSize, file.size);
    const blobPart = file.slice(start, end);

    const urlRes = await fetch(`${API_BASE_URL}/uploads/${encodeURIComponent(initiateData.uploadId)}/part-url`, {
      method: "POST",
      headers: authHeaders(),
      body: JSON.stringify({ key: initiateData.key, partNumber }),
    });
    if (!urlRes.ok) throw new Error(`Failed to get part URL ${partNumber}`);

    const { signedUrl } = await urlRes.json();
    const putRes = await fetch(signedUrl, {
      method: "PUT",
      headers: { "Content-Type": file.type || "application/octet-stream" },
      body: blobPart,
    });
    if (!putRes.ok) throw new Error(`Failed to upload part ${partNumber}`);

    const eTag = putRes.headers.get("ETag");
    if (!eTag) throw new Error(`Missing ETag on part ${partNumber}`);
    parts.push({ PartNumber: partNumber, ETag: eTag });
    setUploadStatus(`Uploading... ${partNumber}/${partCount}`);
  }

  const completeRes = await fetch(`${API_BASE_URL}/uploads/${encodeURIComponent(initiateData.uploadId)}/complete`, {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ key: initiateData.key, parts }),
  });
  if (!completeRes.ok) throw new Error("Failed to finalize upload");
  return completeRes.json();
}

confirmUploadBtn.addEventListener("click", async () => {
  const file = fileInput.files?.[0];
  const clientId = clientIdInput.value.trim();
  const category = categoryInput.value;
  const explicitName = documentNameInput.value.trim();
  if (!file) return setUploadStatus("Select a file first.");
  if (!clientId) return setUploadStatus("Client ID is required.");

  confirmUploadBtn.disabled = true;
  setUploadStatus("Starting upload...");

  try {
    await uploadFileMultipart(file, {
      clientId,
      documentName: explicitName || file.name,
      category,
      client: clientsById[clientId] || clientId,
    });
    await loadDocuments();
    fileInput.value = "";
    documentNameInput.value = "";
    uploadModal.classList.remove("show");
    setUploadStatus("");
  } catch (error) {
    console.error(error);
    setUploadStatus(error.message || "Upload failed.");
  } finally {
    confirmUploadBtn.disabled = false;
  }
});

uploadBtn.addEventListener("click", () => {
  uploadModal.classList.add("show");
  setUploadStatus("");
});
closeUpload.addEventListener("click", () => {
  uploadModal.classList.remove("show");
  setUploadStatus("");
});
cancelUpload.addEventListener("click", () => {
  uploadModal.classList.remove("show");
  setUploadStatus("");
});
uploadModal.addEventListener("click", (e) => {
  if (e.target === uploadModal) {
    uploadModal.classList.remove("show");
    setUploadStatus("");
  }
});

loadClientsMap().then(loadDocuments).catch((error) => console.error(error));
</script>

</body>
</html>


