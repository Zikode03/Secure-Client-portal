<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Notifications ÃƒÂ¢Ã¢â€šÂ¬Ã¢â‚¬Å“ Accounting Portal</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

<style>
:root {
  --primary:#1754cf;
  --bg:#f6f7fb;
  --panel:#ffffff;
  --text:#0e121b;
  --muted:#5b6b8c;
  --border:#e6ebf2;
  --success:#22c55e;
}

/* RESET */
* { box-sizing:border-box; margin:0; padding:0; }
body {
  font-family:"Public Sans",sans-serif;
  background:var(--bg);
  color:var(--text);
  height:100vh;
  overflow:hidden;
}

/* HEADER */
header {
  height:64px;
  background:#fff;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 32px;
}

.brand {
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:700;
}

.brand-icon {
  width:32px;
  height:32px;
  background:var(--primary);
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
}

.header-actions {
  display:flex;
  gap:14px;
}

.icon-btn {
  width:40px;
  height:40px;
  border-radius:10px;
  background:#eef2ff;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  cursor:pointer;
}

.icon-btn .dot {
  position:absolute;
  top:8px;
  right:8px;
  width:8px;
  height:8px;
  background:#ef4444;
  border-radius:50%;
  border:2px solid #fff;
}

/* MAIN PLACEHOLDER */
main {
  height:calc(100vh - 64px);
  background:linear-gradient(#f6f7fb,#eef1f6);
}

/* OVERLAY */
.overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  backdrop-filter:blur(3px);
  display:flex;
  justify-content:flex-end;
}

/* DRAWER */
.drawer {
  width:420px;
  height:100%;
  background:var(--panel);
  box-shadow:-20px 0 40px rgba(0,0,0,.15);
  display:flex;
  flex-direction:column;
  animation:slide .25s ease;
}

@keyframes slide {
  from { transform:translateX(100%); }
  to { transform:translateX(0); }
}

/* DRAWER HEADER */
.drawer-header {
  padding:24px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
}

.drawer-header h2 {
  font-size:20px;
  font-weight:700;
}

.drawer-header p {
  font-size:14px;
  color:var(--muted);
}

.close {
  cursor:pointer;
  color:var(--muted);
}

/* FILTERS */
.filters {
  display:flex;
  gap:8px;
  padding:12px 24px;
  border-bottom:1px solid var(--border);
  background:#f9fbff;
}

.filter {
  padding:6px 14px;
  border-radius:999px;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
}

.filter.active {
  background:var(--primary);
  color:#fff;
}

.filter:not(.active) {
  color:var(--muted);
}

/* LIST */
.list {
  flex:1;
  overflow:auto;
}

/* ITEM */
.item {
  padding:20px 24px;
  border-bottom:1px solid var(--border);
  display:flex;
  gap:14px;
  position:relative;
}

.item.unread {
  background:#f3f7ff;
}

.item.unread::after {
  content:"";
  width:8px;
  height:8px;
  background:var(--primary);
  border-radius:50%;
  position:absolute;
  top:24px;
  right:24px;
}

.icon {
  width:48px;
  height:48px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#e8efff;
  color:var(--primary);
}

.avatar {
  border-radius:50%;
  overflow:hidden;
}

.avatar img {
  width:100%;
  height:100%;
  object-fit:cover;
}

.content h4 {
  font-size:15px;
  font-weight:700;
}

.time {
  font-size:12px;
  color:var(--muted);
}

.content p {
  font-size:14px;
  color:var(--muted);
  margin:6px 0 12px;
}

.actions {
  display:flex;
  gap:14px;
  align-items:center;
}

.btn {
  height:36px;
  padding:0 14px;
  border-radius:10px;
  border:none;
  font-weight:700;
  cursor:pointer;
}

.btn.primary {
  background:var(--primary);
  color:#fff;
}

.btn.outline {
  border:1px solid var(--primary);
  background:#fff;
  color:var(--primary);
}

.link {
  font-size:12px;
  font-weight:700;
  color:var(--muted);
  cursor:pointer;
}

/* FOOTER */
.drawer-footer {
  padding:20px 24px;
  border-top:1px solid var(--border);
}

.drawer-footer .btn {
  width:100%;
  height:48px;
  font-size:15px;
}

.drawer-footer .secondary {
  margin-top:14px;
  text-align:center;
  font-size:14px;
  font-weight:600;
  color:var(--muted);
}
</style>
<link rel="stylesheet" href="../../shared/inline-migrated.css">
</head>

<body>

<header>
  <div class="brand">
    <div class="brand-icon">
      <span class="material-symbols-outlined">account_balance</span>
    </div>
    ProAccount Portal
  </div>
  <div class="header-actions">
    <div class="icon-btn">
      <span class="material-symbols-outlined">notifications</span>
      <span class="dot"></span>
    </div>
    <div class="icon-btn">
      <span class="material-symbols-outlined">account_circle</span>
    </div>
  </div>
</header>

<main></main>

<div class="overlay">
  <div class="drawer">

    <div class="drawer-header">
      <div>
        <h2>Notifications</h2>
        <p id="unreadText">You have 0 unread updates</p>
      </div>
      <span class="material-symbols-outlined close">close</span>
    </div>

    <div class="filters">
      <div class="filter active" data-filter="all">All</div>
      <div class="filter" data-filter="unread">Unread</div>
      <div class="filter" data-filter="action">Action Required</div>
    </div>

    <div class="list" id="notificationList"></div>

    <div class="drawer-footer">
      <button class="btn primary" id="loadMoreBtn">Load More</button>
      <div class="secondary" id="markAllReadBtn">Mark all as read</div>
    </div>

  </div>
</div>

<script src="../../shared/portal-config.js"></script>
<script src="../../shared/portal-auth.js"></script>
<script>
const API_BASE_URL = window.PortalConfig.API_BASE_URL;
const session = window.PortalAuth.requireRole("client", "../Clientlogins/login.html");
if (!session) { throw new Error("Unauthorized"); }
const { token } = session;

function authHeaders() {
  return window.PortalAuth.authHeaders(token);
}

let page = 1;
const limit = 10;
let activeFilter = "all";
let hasMore = false;

function iconForType(type) {
  if (type === "message_received") return "mail";
  if (type === "request_created" || type === "document_request") return "upload_file";
  return "notifications";
}

function renderItems(items, append = false) {
  const list = document.getElementById("notificationList");
  if (!append) list.innerHTML = "";
  for (const n of items) {
    const div = document.createElement("div");
    div.className = `item ${n.read ? "" : "unread"}`;
    div.innerHTML = `
      <div class="icon"><span class="material-symbols-outlined">${iconForType(n.type)}</span></div>
      <div class="content">
        <div class="inl-1141c4304a">
          <h4>${n.title}</h4>
          <span class="time">${new Date(n.createdAt).toLocaleString()}</span>
        </div>
        <p>${n.message}</p>
        <div class="actions">
          <span class="link" data-read-id="${n.id}">${n.read ? "Read" : "Mark as read"}</span>
        </div>
      </div>
    `;
    list.appendChild(div);
  }
}

async function loadNotifications(append = false) {
  const unreadQuery = activeFilter === "unread" ? "&unread=true" : "";
  const typeQuery = activeFilter === "action" ? "&type=request_created" : "";
  const response = await fetch(`${API_BASE_URL}/notifications?page=${page}&limit=${limit}${unreadQuery}${typeQuery}`, {
    headers: authHeaders(),
  });
  if (!response.ok) return;
  const data = await response.json();
  renderItems(data.items || [], append);
  document.getElementById("unreadText").textContent = `You have ${data.unreadCount || 0} unread updates`;
  hasMore = Boolean(data.pagination?.hasMore);
  document.getElementById("loadMoreBtn").style.display = hasMore ? "block" : "none";
}

document.querySelectorAll(".filter").forEach((el) => {
  el.addEventListener("click", () => {
    document.querySelectorAll(".filter").forEach((f) => f.classList.remove("active"));
    el.classList.add("active");
    activeFilter = el.getAttribute("data-filter");
    page = 1;
    loadNotifications(false);
  });
});

document.getElementById("loadMoreBtn").addEventListener("click", () => {
  if (!hasMore) return;
  page += 1;
  loadNotifications(true);
});

document.getElementById("markAllReadBtn").addEventListener("click", async () => {
  const response = await fetch(`${API_BASE_URL}/notifications/read-all`, {
    method: "POST",
    headers: authHeaders(),
    body: "{}",
  });
  if (response.ok) {
    page = 1;
    loadNotifications(false);
  }
});

document.addEventListener("click", async (event) => {
  const readBtn = event.target.closest("[data-read-id]");
  if (!readBtn) return;
  const id = readBtn.getAttribute("data-read-id");
  const response = await fetch(`${API_BASE_URL}/notifications/${encodeURIComponent(id)}/read`, {
    method: "POST",
    headers: authHeaders(),
    body: "{}",
  });
  if (response.ok) {
    page = 1;
    loadNotifications(false);
  }
});

loadNotifications(false);
</script>
</body>
</html>
